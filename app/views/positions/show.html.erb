<div class="flex items-center justify-between mb-8">
  <div>
    <h1 class="text-3xl font-bold text-white inline-flex items-center gap-2">
      <%= @position.asset0 %>/<%= @position.asset1 %>
      <%= link_to position_path(@position), class: "text-gray-400 hover:text-white transition" do %>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.992 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182M21.015 4.356v4.992" />
        </svg>
      <% end %>
    </h1>
    <p class="text-gray-400 mt-1"><%= @position.dex.name.capitalize %> &middot; <%= truncate(@position.pool_address.to_s, length: 20) %></p>
  </div>
  <div class="flex items-center space-x-3">
    <%= button_to "Sync Now", sync_now_position_path(@position), method: :post, class: "bg-gray-700 hover:bg-gray-600 text-gray-300 px-4 py-2 rounded-lg text-sm font-medium transition" %>
    <% if @position.hedge %>
      <%= link_to "View Hedge", hedge_path(@position.hedge), class: "bg-gray-700 hover:bg-gray-600 text-gray-300 px-4 py-2 rounded-lg text-sm font-medium transition" %>
    <% else %>
      <%= link_to "Create Hedge", new_hedge_path(position_id: @position.id), class: "bg-gray-700 hover:bg-gray-600 text-gray-300 px-4 py-2 rounded-lg text-sm font-medium transition" %>
    <% end %>
  </div>
</div>

<% pool_unrealized = @position.entry_value_usd ? @position.total_value_usd - @position.entry_value_usd : nil %>
<% latest_snap = @pnl_snapshots.first %>
<% hedge_unrealized = latest_snap&.hedge_unrealized.to_d %>
<% hedge_realized = latest_snap&.hedge_realized.to_d %>
<% total_pnl = pool_unrealized ? pool_unrealized + hedge_unrealized : hedge_unrealized %>

<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10">
  <div class="bg-gray-900 rounded-xl border border-gray-800 p-4 space-y-2">
    <p class="text-gray-400 text-xs uppercase tracking-wide"><%= @position.asset0 %></p>
    <p class="text-xl font-bold text-white">$<%= number_with_precision(@position.asset0_amount * @position.asset0_price_usd, precision: 2) %></p>
    <p class="text-gray-500 text-sm"><%= number_with_precision(@position.asset0_amount, precision: 6) %> &middot; $<%= number_with_delimiter(number_with_precision(@position.asset0_price_usd, precision: 2)) %>/unit</p>
  </div>
  <div class="bg-gray-900 rounded-xl border border-gray-800 p-4 space-y-2">
    <p class="text-gray-400 text-xs uppercase tracking-wide"><%= @position.asset1 %></p>
    <p class="text-xl font-bold text-white">$<%= number_with_precision(@position.asset1_amount * @position.asset1_price_usd, precision: 2) %></p>
    <p class="text-gray-500 text-sm"><%= number_with_precision(@position.asset1_amount, precision: 2) %> &middot; $<%= number_with_delimiter(number_with_precision(@position.asset1_price_usd, precision: 2)) %>/unit</p>
  </div>
  <div class="bg-gray-900 rounded-xl border border-gray-800 p-4 space-y-2">
    <p class="text-gray-400 text-xs uppercase tracking-wide">Total Pooled Value</p>
    <p class="text-xl font-bold text-white">$<%= number_with_precision(@position.total_value_usd, precision: 2) %></p>
    <% if @position.entry_value_usd %>
      <p class="text-gray-500 text-sm">Entry: $<%= number_with_precision(@position.entry_value_usd, precision: 2) %></p>
    <% else %>
      <p class="text-gray-500 text-sm">$<%= number_with_precision(@position.asset0_amount * @position.asset0_price_usd, precision: 2) %> &middot; $<%= number_with_precision(@position.asset1_amount * @position.asset1_price_usd, precision: 2) %></p>
    <% end %>
  </div>
  <div class="bg-gray-900 rounded-xl border border-gray-800 p-4 space-y-2">
    <p class="text-gray-400 text-xs uppercase tracking-wide">Hedge</p>
    <% if @position.hedge %>
      <% hedge_value = @position.total_value_usd * @position.hedge.target %>
      <p class="text-xl font-bold <%= @position.hedge.active? ? 'text-green-400' : 'text-gray-500' %>">
        $<%= number_with_precision(hedge_value, precision: 2) %>
      </p>
      <p class="text-gray-500 text-sm">Target: <%= number_to_percentage(@position.hedge.target * 100, precision: 0) %> &middot; Tolerance: <%= number_to_percentage(@position.hedge.tolerance * 100, precision: 0) %></p>
    <% else %>
      <p class="text-xl font-bold text-gray-500">None</p>
    <% end %>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
  <div>
    <h2 class="text-xl font-semibold text-white mb-4">PnL Summary</h2>
    <div class="grid grid-cols-2 gap-4">
      <div class="bg-gray-900 rounded-xl border border-gray-800 p-5">
        <p class="text-gray-400 text-xs uppercase tracking-wide">Total Unrealized</p>
        <p class="text-2xl font-bold mt-2 <%= total_pnl >= 0 ? 'text-green-400' : 'text-red-400' %>">
          $<%= number_with_precision(total_pnl, precision: 2) %>
        </p>
        <p class="text-gray-500 text-sm mt-1">
          Pool: <span class="<%= (pool_unrealized || 0) >= 0 ? 'text-green-400' : 'text-red-400' %>">$<%= number_with_precision(pool_unrealized || 0, precision: 2) %></span>
          &middot; Hedge: <span class="<%= hedge_unrealized >= 0 ? 'text-green-400' : 'text-red-400' %>">$<%= number_with_precision(hedge_unrealized, precision: 2) %></span>
        </p>
      </div>
      <div class="bg-gray-900 rounded-xl border border-gray-800 p-5">
        <p class="text-gray-400 text-xs uppercase tracking-wide">Realized PnL</p>
        <p class="text-2xl font-bold mt-2 <%= hedge_realized >= 0 ? 'text-green-400' : 'text-red-400' %>">
          $<%= number_with_precision(hedge_realized, precision: 2) %>
        </p>
      </div>
    </div>
    <% if latest_snap %>
      <p class="text-gray-600 text-xs mt-3">As of <%= latest_snap.captured_at.strftime("%m/%d/%Y %H:%M") %></p>
    <% end %>
  </div>

  <div>
    <h2 class="text-xl font-semibold text-white mb-4">Rebalance History</h2>
    <div class="bg-gray-900 rounded-xl border border-gray-800 overflow-hidden">
      <table class="w-full">
        <thead>
          <tr class="border-b border-gray-800">
            <th class="text-left text-gray-400 text-xs uppercase tracking-wide p-4">Asset</th>
            <th class="text-center text-gray-400 text-xs uppercase tracking-wide p-4"></th>
            <th class="text-right text-gray-400 text-xs uppercase tracking-wide p-4">Old &rarr; New</th>
            <th class="text-right text-gray-400 text-xs uppercase tracking-wide p-4">PnL</th>
            <th class="text-right text-gray-400 text-xs uppercase tracking-wide p-4">Time</th>
          </tr>
        </thead>
        <tbody>
          <% @rebalances.each do |r| %>
            <tr class="border-b border-gray-800/50">
              <td class="p-4 text-white font-medium"><%= r.asset %></td>
              <td class="p-4 text-center">
                <% if r.status == ShortRebalance::STATUS_FAILED %>
                  <span class="inline-block w-2 h-2 rounded-full bg-red-500" title="Failed: <%= r.message %>"></span>
                <% else %>
                  <span class="inline-block w-2 h-2 rounded-full bg-green-500"></span>
                <% end %>
              </td>
              <td class="p-4 text-right text-gray-300">
                <%= number_with_precision(r.old_short_size, precision: 4) %> &rarr; <%= number_with_precision(r.new_short_size, precision: 4) %>
              </td>
              <td class="p-4 text-right <%= r.realized_pnl.to_d >= 0 ? 'text-green-400' : 'text-red-400' %>">
                $<%= number_with_precision(r.realized_pnl, precision: 2) %>
              </td>
              <td class="p-4 text-right text-gray-400 text-sm"><%= time_ago_in_words(r.rebalanced_at) %> ago</td>
            </tr>
          <% end %>
          <% if @rebalances.empty? %>
            <tr><td colspan="5" class="p-8 text-center text-gray-500">No rebalances yet.</td></tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

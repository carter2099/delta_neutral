<div class="flex items-center justify-between mb-8">
  <div>
    <h1 class="text-3xl font-bold text-white inline-flex items-center gap-2">
      <%= @position.asset0 %>/<%= @position.asset1 %>
      <%= link_to position_path(@position), class: "text-gray-400 hover:text-white transition" do %>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.992 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182M21.015 4.356v4.992" />
        </svg>
      <% end %>
    </h1>
    <p class="text-gray-400 mt-1 flex items-center gap-2">
      <%= @position.dex.name.capitalize %> &middot;
      <span id="copy-address" class="cursor-pointer hover:text-white transition inline-flex items-center gap-1" title="<%= @position.pool_address %>" onclick="navigator.clipboard.writeText('<%= @position.pool_address %>'); var icon=this.querySelector('.copy-icon'); icon.innerHTML='<path stroke-linecap=\'round\' stroke-linejoin=\'round\' d=\'M4.5 12.75l6 6 9-13.5\' />'; icon.classList.add('text-green-400'); setTimeout(function(){ icon.innerHTML='<path stroke-linecap=\'round\' stroke-linejoin=\'round\' d=\'M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75\' />'; icon.classList.remove('text-green-400'); }, 1500)">
        <%= @position.pool_address.to_s[0..5] %>&hellip;<%= @position.pool_address.to_s[-4..] %>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 copy-icon">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75" />
        </svg>
      </span>
    </p>
  </div>
  <div class="flex items-center space-x-3">
    <%= button_to "Sync Now", sync_now_position_path(@position), method: :post, class: "bg-gray-700 hover:bg-gray-600 text-gray-300 px-4 py-2 rounded-lg text-sm font-medium transition" %>
    <% if @position.hedge %>
      <%= link_to "View Hedge", hedge_path(@position.hedge), class: "bg-gray-700 hover:bg-gray-600 text-gray-300 px-4 py-2 rounded-lg text-sm font-medium transition" %>
    <% else %>
      <%= link_to "Create Hedge", new_hedge_path(position_id: @position.id), class: "bg-gray-700 hover:bg-gray-600 text-gray-300 px-4 py-2 rounded-lg text-sm font-medium transition" %>
    <% end %>
  </div>
</div>

<% pool_unrealized = @position.entry_value_usd ? @position.total_value_usd - @position.entry_value_usd : nil %>
<% latest_snap = @pnl_snapshots.first %>
<% hedge_unrealized = latest_snap&.hedge_unrealized.to_d %>
<% hedge_realized = latest_snap&.hedge_realized.to_d %>
<% total_unrealized = pool_unrealized ? pool_unrealized + hedge_unrealized : hedge_unrealized %>
<% total_fees = latest_snap&.total_fees_usd || 0 %>
<% total_pnl = total_unrealized + hedge_realized + total_fees %>

<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10">
  <div class="bg-gray-900 rounded-xl border border-gray-800 p-4 space-y-2">
    <p class="text-gray-400 text-xs uppercase tracking-wide"><%= @position.asset0 %></p>
    <p class="text-xl font-bold text-white"><%= format_usd(@position.asset0_amount * @position.asset0_price_usd) %></p>
    <p class="text-gray-500 text-sm"><%= number_with_precision(@position.asset0_amount, precision: 6) %> &middot; <%= format_usd(@position.asset0_price_usd) %>/unit</p>
  </div>
  <div class="bg-gray-900 rounded-xl border border-gray-800 p-4 space-y-2">
    <p class="text-gray-400 text-xs uppercase tracking-wide"><%= @position.asset1 %></p>
    <p class="text-xl font-bold text-white"><%= format_usd(@position.asset1_amount * @position.asset1_price_usd) %></p>
    <p class="text-gray-500 text-sm"><%= number_with_precision(@position.asset1_amount, precision: 2) %> &middot; <%= format_usd(@position.asset1_price_usd) %>/unit</p>
  </div>
  <div class="bg-gray-900 rounded-xl border border-gray-800 p-4 space-y-2">
    <p class="text-gray-400 text-xs uppercase tracking-wide">Total Pooled Value</p>
    <p class="text-xl font-bold text-white"><%= format_usd(@position.total_value_usd) %></p>
    <% if @position.entry_value_usd %>
      <p class="text-gray-500 text-sm">Entry: <%= format_usd(@position.entry_value_usd) %></p>
    <% else %>
      <p class="text-gray-500 text-sm"><%= format_usd(@position.asset0_amount * @position.asset0_price_usd) %> &middot; <%= format_usd(@position.asset1_amount * @position.asset1_price_usd) %></p>
    <% end %>
  </div>
  <div class="bg-gray-900 rounded-xl border border-gray-800 p-4 space-y-2">
    <p class="text-gray-400 text-xs uppercase tracking-wide">Hedge</p>
    <% if @position.hedge %>
      <% hedge_value = @position.total_value_usd * @position.hedge.target %>
      <p class="text-xl font-bold <%= @position.hedge.active? ? 'text-green-400' : 'text-gray-500' %>">
        <%= format_usd(hedge_value) %>
      </p>
      <p class="text-gray-500 text-sm">Target: <%= number_to_percentage(@position.hedge.target * 100, precision: 0) %> &middot; Tolerance: <%= number_to_percentage(@position.hedge.tolerance * 100, precision: 0) %></p>
    <% else %>
      <p class="text-xl font-bold text-gray-500">None</p>
    <% end %>
  </div>
</div>

<h2 class="text-xl font-semibold text-white mb-4">PnL Summary</h2>
<div class="grid grid-cols-3 gap-4 mb-6">
  <div class="bg-gray-900 rounded-xl border border-gray-800 p-5">
    <p class="text-gray-400 text-xs uppercase tracking-wide">Total PnL</p>
    <p class="text-2xl font-bold mt-2 <%= total_pnl >= 0 ? 'text-green-400' : 'text-red-400' %>">
      <%= format_usd(total_pnl) %>
    </p>
    <p class="text-gray-500 text-sm mt-1">
      Unrealized: <span class="<%= total_unrealized >= 0 ? 'text-green-400' : 'text-red-400' %>"><%= format_usd(total_unrealized) %></span>
      &middot; Realized: <span class="<%= hedge_realized >= 0 ? 'text-green-400' : 'text-red-400' %>"><%= format_usd(hedge_realized) %></span>
      &middot; Fees: <span class="text-green-400"><%= format_usd(total_fees) %></span>
    </p>
  </div>
  <div class="bg-gray-900 rounded-xl border border-gray-800 p-5">
    <p class="text-gray-400 text-xs uppercase tracking-wide">Total Unrealized</p>
    <p class="text-2xl font-bold mt-2 <%= total_unrealized >= 0 ? 'text-green-400' : 'text-red-400' %>">
      <%= format_usd(total_unrealized) %>
    </p>
    <p class="text-gray-500 text-sm mt-1">
      Pool: <span class="<%= (pool_unrealized || 0) >= 0 ? 'text-green-400' : 'text-red-400' %>"><%= format_usd(pool_unrealized || 0) %></span>
      &middot; Hedge: <span class="<%= hedge_unrealized >= 0 ? 'text-green-400' : 'text-red-400' %>"><%= format_usd(hedge_unrealized) %></span>
    </p>
  </div>
  <div class="bg-gray-900 rounded-xl border border-gray-800 p-5">
    <p class="text-gray-400 text-xs uppercase tracking-wide">Realized PnL</p>
    <p class="text-2xl font-bold mt-2 <%= hedge_realized >= 0 ? 'text-green-400' : 'text-red-400' %>">
      <%= format_usd(hedge_realized) %>
    </p>
  </div>
</div>
<% if latest_snap %>
  <p class="text-gray-600 text-xs mb-8">As of <%= latest_snap.captured_at.strftime("%m/%d/%Y %H:%M") %></p>
<% end %>

<h2 class="text-xl font-semibold text-white mb-4">LP Fees</h2>
<div class="grid grid-cols-3 gap-4">
  <div class="bg-gray-900 rounded-xl border border-gray-800 p-5">
    <p class="text-gray-400 text-xs uppercase tracking-wide">Collected</p>
    <p class="text-2xl font-bold mt-2 text-green-400">
      <%= format_usd(latest_snap&.collected_fees_usd || 0) %>
    </p>
  </div>
  <div class="bg-gray-900 rounded-xl border border-gray-800 p-5">
    <p class="text-gray-400 text-xs uppercase tracking-wide">Uncollected</p>
    <p class="text-2xl font-bold mt-2 text-green-400">
      <%= format_usd(latest_snap&.uncollected_fees_usd || 0) %>
    </p>
  </div>
  <div class="bg-gray-900 rounded-xl border border-gray-800 p-5">
    <p class="text-gray-400 text-xs uppercase tracking-wide">Total Fees</p>
    <p class="text-2xl font-bold mt-2 text-green-400">
      <%= format_usd(latest_snap&.total_fees_usd || 0) %>
    </p>
  </div>
</div>
